# .github/workflows/android-ci.yml
# Android 프로젝트에 대한 기본 CI 파이프라인 정의
# master 브랜치에 대한 push/PR 및 수동 실행을 트리거로 동작
name: 1. Android CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # CI 워크플로우 초기화 단계 (release 체크, 메타데이터 생성 등)
  initialize-check:
    name: Initialize Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 5
        # 저장소 코드를 CI 환경으로 가져옴
        # fetch-depth: 최근 5개 커밋 히스토리 가져오기 (릴리즈 메타데이터 파싱용)

      - name: Initialize workflow
        run: |
          # CI 실행 기본 정보를 출력하여 로그에서 쉽게 확인 가능하도록 함
          echo "=== CI Workflow Started ==="
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "==========================="

      - name: Parse release metadata from commit message
        # 커밋 메시지에서 [release] 블록 파싱 및 메타데이터 생성
        id: parse_release
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)

          echo "=== Commit Message ==="
          echo "$COMMIT_MSG"
          echo "======================"

          # [release] 블록이 있는지 확인
          if echo "$COMMIT_MSG" | grep -q '\[release\]'; then
            echo "[release] block found!"
            echo "should_release=true" >> $GITHUB_OUTPUT

            # Tag 추출 (앞의 공백 허용)
            TAG=$(echo "$COMMIT_MSG" | grep -i '^[[:space:]]*Tag' | sed 's/^[[:space:]]*Tag[[:space:]]*:[[:space:]]*//' | tr -d '\r')
            echo "Extracted TAG: '$TAG'"
            echo "tag=$TAG" >> $GITHUB_OUTPUT

            # Title 추출 (앞의 공백 허용)
            TITLE=$(echo "$COMMIT_MSG" | grep -i '^[[:space:]]*Title' | sed 's/^[[:space:]]*Title[[:space:]]*:[[:space:]]*//' | tr -d '\r')
            echo "Extracted TITLE: '$TITLE'"
            echo "title=$TITLE" >> $GITHUB_OUTPUT

            # Describe 추출 (여러 줄 가능, 앞의 공백 허용)
            DESCRIBE=$(echo "$COMMIT_MSG" | sed -n '/^[[:space:]]*Describe[[:space:]]*:/,/^$/p' | sed '1s/^[[:space:]]*Describe[[:space:]]*:[[:space:]]*//' | sed '/^$/d' | tr -d '\r')
            echo "Extracted DESCRIBE: '$DESCRIBE'"
            {
              echo "body<<EOF"
              echo "$DESCRIBE"
              echo "EOF"
            } >> $GITHUB_OUTPUT

            echo "testers=" >> $GITHUB_OUTPUT

            echo "Release metadata parsed: Tag=$TAG, Title=$TITLE"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "No [release] block found in commit message."
          fi

      - name: Save release metadata to file
        # 파싱된 메타데이터를 JSON 파일로 저장 (CD 워크플로우 전달용)
        if: steps.parse_release.outputs.should_release == 'true'
        run: |
          mkdir -p metadata
          cat > metadata/release-metadata.json <<EOF
          {
            "should_release": "${{ steps.parse_release.outputs.should_release }}",
            "tag": "${{ steps.parse_release.outputs.tag }}",
            "title": "${{ steps.parse_release.outputs.title }}",
            "body": "${{ steps.parse_release.outputs.body }}",
            "testers": "${{ steps.parse_release.outputs.testers }}"
          }
          EOF
          cat metadata/release-metadata.json

      - name: Upload release metadata
        # CD 워크플로우가 사용할 수 있도록 메타데이터 아티팩트 업로드
        if: steps.parse_release.outputs.should_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-metadata
          path: metadata/release-metadata.json
          retention-days: 1

  # Kotlin 코드 스타일 검사 단계
  ktlint:
    name: KtLint Check
    runs-on: ubuntu-latest
    needs: initialize-check
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # 저장소 코드를 CI 환경으로 가져옴

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
        # Kotlin 컴파일 및 Gradle 빌드에 필요한 Java 17 설치

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          # Gradle 캐시 쓰기 허용 및 성공 시 자동 정리로 디스크 공간 관리
          cache-read-only: false
          cache-cleanup: on-success
        # Gradle 빌드 도구 설정 및 의존성 캐싱으로 빌드 속도 향상

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        # Gradle Wrapper 실행 권한 부여 (Unix/Linux 환경)

      - name: Run KtLint
        # Kotlin 코드 스타일 위반 여부를 검사하고 결과 로그를 저장
        # .editorconfig 파일의 규칙을 기반으로 코드 스타일 검증
        run: bash -o pipefail -c "./gradlew ktlintCheck --build-cache |& tee ktlint.log"

      - name: Capture failure snippet (ktlint)
        if: failure()
        run: |
          # KtLint 실패 시 로그 분석
          # - Python 스크립트로 Gradle 로그에서 핵심 에러만 추출
          # - 첫 줄 요약을 GitHub UI에 표시하여 빠른 원인 파악 지원
          python3 .github/scripts/extract_gradle_failure.py ktlint.log ktlint-failure.log
          SUMMARY="$(head -n 1 ktlint-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="KtLint check failed."
          fi
          {
            echo "KTLINT_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "KTLINT_FAILURE_LOG_PATH=$(pwd)/ktlint-failure.log"
          } >> "$GITHUB_ENV"

      - name: Report failure (KtLint Check)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "KtLint Check"
          FAILURE_MESSAGE: ${{ env.KTLINT_FAILURE_SUMMARY || 'KtLint check failed.' }}
          FAILURE_LOG_PATH: ${{ env.KTLINT_FAILURE_LOG_PATH }}
          ISSUE_LABELS: "CI-KtLint"
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        # 실패 시 공통 에러 리포트 스크립트 호출하여 GitHub Issue 생성 또는 알림
        run: bash .github/scripts/report_action_error.sh

  # Unit 테스트 및 Robolectric 테스트 실행 단계
  test:
    name: Tests (Unit, Robolectric)
    runs-on: ubuntu-latest
    needs: ktlint
    permissions:
      contents: read
      checks: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # 저장소 코드를 CI 환경으로 가져옴

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
        # 테스트 실행에 필요한 Java 17 설치

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          # Gradle 캐시 쓰기 허용 및 성공 시 자동 정리로 디스크 공간 관리
          cache-read-only: false
          cache-cleanup: on-success
        # Gradle 빌드 도구 설정 및 의존성 캐싱으로 빌드 속도 향상

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        # Gradle Wrapper 실행 권한 부여 (Unix/Linux 환경)

      - name: Run tests and generate coverage
        # koverHtmlReport Task 수행:
        # 1. Unit Test 및 Robolectric Test 실행
        # 2. Kover 플러그인으로 코드 커버리지 측정
        # 3. HTML 형식의 커버리지 리포트 생성
        run: bash -o pipefail -c "./gradlew :library:koverHtmlReport --build-cache |& tee test-coverage.log"

      - name: Capture failure snippet (Tests)
        if: failure()
        id: test_failure_snippet
        run: |
          # 테스트 실패 시 로그 분석
          # - Python 스크립트로 Gradle 로그에서 핵심 에러만 추출
          # - 실패한 테스트 케이스 및 에러 메시지 요약 생성
          python3 .github/scripts/extract_gradle_failure.py test-coverage.log test-failure-snippet.log
          SUMMARY="$(head -n 1 test-failure-snippet.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Tests or coverage generation failed."
          fi
          {
            echo "TEST_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "TEST_FAILURE_LOG_PATH=$(pwd)/test-failure-snippet.log"
          } >> "$GITHUB_ENV"

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            library/build/test-results/**/*.xml
          check_name: Test Results
        # 테스트 결과를 GitHub PR/Commit에 직접 표시 (성공/실패 케이스 수 등)

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            library/build/reports/tests/
          retention-days: 30
        # HTML 형식의 상세 테스트 리포트를 아티팩트로 업로드 (30일 보관)

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-report
          path: |
            library/build/reports/kover/html/
          retention-days: 30
        # 코드 커버리지 HTML 리포트를 아티팩트로 업로드 (성공 시만, 30일 보관)

      - name: Report failure (Tests)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Tests (Unit, Robolectric)"
          FAILURE_MESSAGE: ${{ env.TEST_FAILURE_SUMMARY || 'Tests failed. Please inspect test logs.' }}
          FAILURE_LOG_PATH: ${{ env.TEST_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        # 실패 시 공통 에러 리포트 스크립트 호출하여 GitHub Issue 생성 또는 알림
        run: bash .github/scripts/report_action_error.sh

  # APK/AAR 빌드 및 Android Lint 검사 단계
  build:
    name: Build and Lint Check
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      checks: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # 저장소 코드를 CI 환경으로 가져옴

      - name: Prepare Google Services config
        run: |
          cat <<'EOF' > app/google-services.json
          ${{ secrets.FIREBASE_CREDENTIALS }}
          EOF
        # Firebase 연동을 위한 google-services.json 파일 생성
        # GitHub Secrets에 저장된 Firebase 설정을 사용

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2
        # Gradle Wrapper 파일의 무결성 검증 (보안 검사)

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
        # Android 빌드에 필요한 Java 17 설치

      - name: Set up Android SDK (base)
        uses: android-actions/setup-android@v3
        # Android SDK 기본 설치

      - name: Accept SDK licenses
        run: yes | sdkmanager --licenses
        # Android SDK 라이선스 자동 동의

      - name: Install SDK packages
        run: sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"
        # Android 35 플랫폼, 빌드 도구, 플랫폼 도구 설치

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          # Gradle 캐시 쓰기 허용 및 성공 시 자동 정리로 디스크 공간 관리
          cache-read-only: false
          cache-cleanup: on-success
        # Gradle 빌드 도구 설정 및 의존성 캐싱으로 빌드 속도 향상

      - name: Make gradlew executable
        run: chmod +x ./gradlew
        # Gradle Wrapper 실행 권한 부여 (Unix/Linux 환경)

      - name: Assemble
        # APK 및 AAR 파일 빌드
        # - app 모듈: APK 생성
        # - library 모듈: AAR 생성 (향후 Jitpack 배포용)
        run: bash -o pipefail -c "./gradlew assemble --stacktrace --build-cache |& tee build-assemble.log"

      - name: Capture failure snippet (assemble)
        if: failure()
        run: |
          # 빌드 실패 시 로그 분석
          # - Python 스크립트로 Gradle 로그에서 핵심 에러만 추출
          # - 컴파일 에러, 의존성 문제 등 빌드 실패 원인 요약
          python3 .github/scripts/extract_gradle_failure.py build-assemble.log build-assemble-failure.log
          SUMMARY="$(head -n 1 build-assemble-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Build job failed while assembling artifacts."
          fi
          {
            echo "BUILD_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "BUILD_FAILURE_LOG_PATH=$(pwd)/build-assemble-failure.log"
            echo "BUILD_FAILURE_SOURCE=assemble"
          } >> "$GITHUB_ENV"

      - name: Android Lint
        # Android Lint 실행:
        # - 코드 품질 검사 (unused resources, deprecated API 등)
        # - 잠재적 버그 탐지 (NullPointerException 가능성 등)
        # - 성능 이슈 검사
        # - 보안 취약점 검사
        run: bash -o pipefail -c "./gradlew lint --build-cache |& tee build-lint.log"

      - name: Capture failure snippet (lint)
        if: failure()
        run: |
          # Lint 실패 시 로그 분석
          # - Python 스크립트로 Gradle 로그에서 핵심 에러만 추출
          # - Lint 오류 및 경고 요약
          python3 .github/scripts/extract_gradle_failure.py build-lint.log build-lint-failure.log
          SUMMARY="$(head -n 1 build-lint-failure.log | tr -d '\r')"
          if [ -z "$SUMMARY" ]; then
            SUMMARY="Build job failed while running lint."
          fi
          {
            echo "BUILD_FAILURE_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "BUILD_FAILURE_LOG_PATH=$(pwd)/build-lint-failure.log"
            echo "BUILD_FAILURE_SOURCE=lint"
          } >> "$GITHUB_ENV"

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            **/build/reports/**
            **/build/test-results/**
          if-no-files-found: ignore
        # 빌드 및 Lint 리포트를 아티팩트로 업로드 (성공/실패 관계없이)

      - name: Report failure (Build and Lint Check)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGE_NAME: "Build and Lint Check"
          FAILURE_MESSAGE: ${{ env.BUILD_FAILURE_SUMMARY || 'Build and Lint Check job failed (tests, coverage, assemble, or lint).' }}
          FAILURE_LOG_PATH: ${{ env.BUILD_FAILURE_LOG_PATH }}
          FAILURE_ENVIRONMENT: |
            Runner: ${{ runner.os }}
            Event: ${{ github.event_name }}
        # 실패 시 공통 에러 리포트 스크립트 호출하여 GitHub Issue 생성 또는 알림
        run: bash .github/scripts/report_action_error.sh
